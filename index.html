<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer" />
  <title>Ignite Digital — Hub</title>

  <!-- Raleway font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand-orange:#EF7F2B;
      --brand-white:#FFFFFF;
      --brand-gray:#A7A8AC;

      /* Light UI */
      --bg-color:#F7F9FC;
      --panel-bg:#FFFFFF;
      --panel-subtle:#FAFBFD;
      --border-color:#E4E7EC;
      --text-color:#1E293B;
      --text-muted:#6B7280;
      --accent:var(--brand-orange);
      --shadow:0 8px 24px rgba(16,24,40,0.08);
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      overflow:auto;
      font-family:"Raleway",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--text-color); background:var(--bg-color);
      display:flex; flex-direction:column;
    }

    /* Error banner */
    #errbar{
      display:none; position:fixed; top:0; left:0; right:0; z-index:9999;
      background:#fff4f4; color:#7a1111; border-bottom:1px solid #f2caca;
      padding:8px 12px; font-size:14px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    #errbar strong{margin-right:8px}

    .dashboard-container{
      display:flex; flex:1 1 auto;
      min-height:0;
      overflow:hidden;
    }
    .sidebar{
      width:360px; background:var(--panel-bg); border-right:1px solid var(--border-color);
      padding:22px; display:flex; flex-direction:column; gap:18px;
      overflow-y:auto; -webkit-overflow-scrolling:touch; min-height:0;
    }
    .main-content{
      flex:1 1 auto; display:flex; flex-direction:column; overflow:hidden; min-height:0;
    }

    /* Header (centered & larger) */
    .header{
      display:flex; flex-direction:column; align-items:center; gap:10px;
      background:var(--panel-bg); border-bottom:1px solid var(--border-color); padding:18px 26px;
      flex:0 0 auto; text-align:center;
    }
    .brand{display:flex; align-items:center; gap:12px; justify-content:center}
    .brand img{height:44px; width:auto; display:block}
    .brand h1{margin:0; font-size:2rem; font-weight:900; color:#111827; letter-spacing:.2px}

    /* Timezones bar (HUGE, centered; target ~weather card height) */
    #timezones{
      display:flex; flex-wrap:wrap; gap:16px; justify-content:center;
      font-weight:900; color:#334155; padding:22px 18px;
      background:var(--panel-bg); border-bottom:1px solid var(--border-color);
      min-height:150px; /* creates a tall band akin to the weather card */
    }
    #timezones .tz{
      display:flex; align-items:center; gap:12px;
      background:var(--panel-subtle); border:1px solid var(--border-color);
      padding:16px 22px; border-radius:18px;
      font-size:3.25rem; /* BIG — roughly matches weather card's visual weight */
      line-height:1.1;
      box-shadow:var(--shadow);
    }
    #timezones .tz .tz-abbr{font-weight:900; color:#111827}

    .widget{
      background:var(--panel-bg); border:1px solid var(--border-color);
      border-radius:14px; padding:16px; box-shadow:var(--shadow);
    }
    .widget-title{
      margin:0 0 12px 0; padding-bottom:10px;
      font-size:1.05rem; font-weight:800; color:#111827;
      border-bottom:1px solid #EEF2F6;
    }

    /* Weather */
    #weather-widget .temp-main{font-size:3rem; font-weight:800; text-align:center}
    #weather-widget .weather-desc{font-size:1.1rem; text-align:center; margin:-4px 0 8px 0}
    #weather-widget .temp-range{font-size:.95rem; text-align:center; color:var(--text-muted)}

    /* Word & Quote */
    #word-widget .word{font-size:1.2rem; font-weight:800; color:var(--accent)}
    #word-widget .phonetic{color:var(--text-muted)}
    #word-widget .definition{font-size:.98rem; line-height:1.55}
    #quote-widget .quote-content{font-style:italic; border-left:3px solid var(--accent); padding-left:12px}
    #quote-widget .quote-author{font-weight:700; text-align:right; color:#6B7280}

    /* News layout containers */
    .news-container{
      flex:1 1 auto; padding:22px; overflow-y:auto; -webkit-overflow-scrolling:touch; min-height:0;
    }
    #featured-article,#grid-container{transition:opacity .35s ease}
    #featured-article{margin-bottom:22px}
    #grid-container{position:relative; min-height:200px;}

    /* Cards */
    .card{
      background:var(--panel-bg); border:1px solid var(--border-color);
      border-radius:14px; overflow:hidden; display:flex; box-shadow:var(--shadow);
    }
    .featured-card{flex-direction:row; min-height:240px}
    .featured-card .article-image{width:45%; object-fit:cover; height:auto; max-height:420px}
    .grid-card{flex-direction:column}
    .grid-card .article-image{width:100%; height:170px; object-fit:cover}
    .article-content{padding:16px; display:flex; flex-direction:column}
    .article-header{display:flex; justify-content:space-between; margin-bottom:8px}
    .source-label{background:var(--accent); color:#fff; padding:4px 10px; border-radius:12px; font-size:.75rem; font-weight:800}
    .time-ago{font-size:.82rem; color:var(--text-muted)}
    .article-title a{color:#0F172A; text-decoration:none; font-weight:800}
    .article-title a:hover{color:var(--accent)}
    .article-summary{color:#475569; font-size:.95rem}

    /* Ticker */
    .ticker-wrap{width:100%; overflow:hidden; height:46px; background:var(--panel-bg);
      border-top:1px solid var(--border-color); padding-left:100%}
    .ticker-move{display:inline-block; height:46px; line-height:46px; white-space:nowrap;
      padding-right:100%; animation:ticker 150s linear infinite; color:var(--text-muted)}
    .ticker-item{display:inline-block; padding:0 2rem}
    @keyframes ticker{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-100%,0,0)}}

    /* Crossfades */
    .fade-host { position: relative; min-height: 1px; }
    .fade-host > * { will-change: opacity, transform; }
    .fade-enter { opacity:0; transform: translateY(6px); }
    .fade-enter.fade-enter-active { opacity:1; transform:none; transition: opacity .35s ease, transform .35s ease; }
    .fade-exit { opacity:1; transform:none; }
    .fade-exit.fade-exit-active { opacity:0; transform: translateY(-6px); transition: opacity .28s ease, transform .28s ease; }

    .grid-swap{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(360px, 1fr));
      gap:18px;
    }

    @media (prefers-reduced-motion: reduce) {
      .fade-enter, .fade-enter-active, .fade-exit, .fade-exit-active { transition: none !important; transform: none !important; }
    }
  </style>
</head>
<body>
  <div id="errbar"><strong>Script error:</strong><span id="errtxt"></span></div>

  <div class="dashboard-container">
    <aside class="sidebar">
      <div id="weather-widget" class="widget">
        <h3 class="widget-title">Mississauga, ON</h3>
        <div id="weather-content"></div>
      </div>

      <!-- MULTI-COMMUTE WIDGET -->
      <div id="commute-widget" class="widget">
        <h3 class="widget-title">Live Commute</h3>
        <div id="travel-times"></div>
        <div id="travel-updated" style="margin-top:6px; color:#6B7280; font-size:.85rem;"></div>
      </div>

      <div id="quote-widget" class="widget">
        <h3 class="widget-title">Quote</h3>
        <div id="quote-content"></div>
      </div>
      <div id="word-widget" class="widget">
        <h3 class="widget-title">Word of the Day</h3>
        <div id="word-content"></div>
      </div>
    </aside>

    <div class="main-content">
      <!-- Centered header -->
      <header class="header">
        <div class="brand">
          <img src="https://ignitedigital.com/wp-content/uploads/2025/07/Ignite-Digital-Logo.png" alt="Ignite Digital logo" />
          <h1>Tech & Marketing Briefing</h1>
        </div>
      </header>

      <!-- Timezones bar (centered, very large) -->
      <div id="timezones"></div>

      <div class="news-container">
        <main id="featured-article" class="fade-host"></main>
        <section id="grid-container" class="fade-host"></section>
      </div>
    </div>
  </div>

  <footer class="ticker-wrap">
    <div class="ticker-move" id="news-ticker"></div>
  </footer>

  <script>
    /* ===== Error banner ===== */
    (function(){
      const bar = document.getElementById('errbar');
      const txt = document.getElementById('errtxt');
      window.addEventListener('error', e=>{
        bar.style.display='block';
        txt.textContent = (e.message||'') + (e.filename? ' @ ' + e.filename : '') + (e.lineno? ':'+e.lineno:'');
      });
      window.addEventListener('unhandledrejection', e=>{
        bar.style.display='block';
        txt.textContent = (e.reason && e.reason.message) ? e.reason.message : (''+e.reason);
      });
    })();

    /* ========================== CONFIG ========================== */
    const feedUrls = [
      "https://venturebeat.com/category/ai/feed/",
      "https://www.marktechpost.com/feed/",
      "https://www.syncedreview.com/feed/",
      "https://www.artificialintelligence-news.com/feed/",
      "https://www.searchenginejournal.com/feed/",
      "https://searchengineland.com/feed",
      "https://moz.com/blog/feed",
      "https://ahrefs.com/blog/feed/",
      "https://www.contentmarketinginstitute.com/feed/",
      "https://www.hubspot.com/insiders/rss.xml",
      "https://www.socialmediatoday.com/.rss/full/",
      "https://techcrunch.com/feed/",
      "https://www.theverge.com/rss/index.xml"
    ];

    const latitude = 43.59, longitude = -79.64;
    const dailyWords = ["ephemeral","ubiquitous","mellifluous","petrichor","serendipity","sonder","eloquence","solitude","ineffable","limerence","epoch","vestige","cynosure"];

    let articlesPool = [];
    let currentArticleIndex = 0;

    const tzElement         = document.getElementById('timezones');
    const weatherContent    = document.getElementById('weather-content');
    const featuredContainer = document.getElementById('featured-article');
    const gridContainer     = document.getElementById('grid-container');
    const newsTicker        = document.getElementById('news-ticker');
    const wordContent       = document.getElementById('word-content');
    const quoteContent      = document.getElementById('quote-content');

    /* ========================== UTIL ========================== */
    function updateTimezones(){
      const now = new Date();
      const options = {hour:'2-digit', minute:'2-digit'};
      const local = now.toLocaleTimeString([], options);

      const zones = {
        Local: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local',
        EST: 'America/New_York',
        CST: 'America/Chicago',
        MST: 'America/Denver',
        PST: 'America/Los_Angeles'
      };

      const tzHtml = Object.entries(zones).map(([abbr, tz])=>{
        const t = abbr === 'Local' ? local : now.toLocaleTimeString([], {...options, timeZone: tz});
        return `<div class="tz"><span class="tz-abbr">${abbr}</span> ${t}</div>`;
      }).join('');

      tzElement.innerHTML = tzHtml;
    }

    function truncateText(text, maxLength){
      if(!text) return '';
      const cleaned = text.replace(/<[^>]*>/g,'');
      if(cleaned.length<=maxLength) return cleaned;
      const cut = cleaned.substr(0, maxLength);
      const lastSpace = cut.lastIndexOf(' ');
      return (lastSpace>0 ? cut.substr(0,lastSpace) : cut) + '…';
    }
    window.truncateText = truncateText;

    function getWeatherIcon(wmoCode){
      const icons = {'0':'☀️','1':'🌤️','2':'☁️','3':'☁️','45':'🌫️','48':'🌫️','51':'🌧️','53':'🌧️','55':'🌧️','61':'🌧️','63':'🌧️','65':'🌧️','80':'🌦️','81':'🌦️','82':'🌦️','95':'⛈️','96':'⛈️','99':'⛈️'};
      return icons[wmoCode]||'—';
    }

    function formatTimeAgo(dateString){
      const now = new Date(), past = new Date(dateString);
      const seconds = Math.floor((now - past)/1000);
      if (seconds < 60) return "just now";
      let i = seconds/31536000; if (i>=1) return Math.floor(i)+" years ago";
      i = seconds/2592000; if (i>=1) return Math.floor(i)+" months ago";
      i = seconds/86400; if (i>=1) return Math.floor(i)+" days ago";
      i = seconds/3600; if (i>=1) return Math.floor(i)+" hours ago";
      i = seconds/60; if (i>=1) return Math.floor(i)+" minutes ago";
      return Math.floor(seconds) + " seconds ago";
    }

    /* -------- Crossfade helpers -------- */
    function renderArticleNode(item, type) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = renderArticle(item, type).trim();
      return wrapper.firstElementChild;
    }
    function crossfadeReplace(host, nextNode) {
      const prev = host.firstElementChild;
      nextNode.classList.add('fade-enter');
      host.insertBefore(nextNode, prev || null);
      void nextNode.offsetHeight;
      nextNode.classList.add('fade-enter-active');
      if (prev) {
        prev.classList.add('fade-exit'); void prev.offsetHeight; prev.classList.add('fade-exit-active');
        prev.addEventListener('transitionend', () => { if (prev && prev.parentNode === host) prev.remove(); }, { once: true });
      }
      nextNode.addEventListener('transitionend', () => { nextNode.classList.remove('fade-enter', 'fade-enter-active'); }, { once: true });
    }

    /* ========================== WEATHER ========================== */
    async function fetchWeather(){
      try{
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=auto`);
        const data = await res.json();
        if(!data || !data.current){ throw new Error('Weather API response empty'); }
        weatherContent.innerHTML = `
          <div class="temp-main">${Math.round(data.current.temperature_2m)}°</div>
          <div class="weather-desc">${getWeatherIcon(String(data.current.weather_code))}</div>
          <div class="temp-range">H: ${Math.round(data.daily.temperature_2m_max[0])}°   L: ${Math.round(data.daily.temperature_2m_min[0])}°</div>
        `;
      }catch(e){
        console.error("Weather error:", e);
        weatherContent.innerHTML = `<small style="color:var(--text-muted)">Weather unavailable.</small>`;
      }
    }

    /* ========================== MULTI-COMMUTE (15 min) ========================== */
    const TOMTOM_API_KEY = 'JU0CF4lFiUjrmA30OEiLIuTZtnrTuqYE';

    // Origin (Mississauga) — ensure LAT,LON order when building paths
    const ORIGIN = { lat: 43.5952, lon: -79.7450 };

    // Destinations to geocode once, then reuse (5 total)
    const DESTINATIONS = [
      { label: 'Union Station (Toronto)',             query: 'Union Station, Toronto ON' },
      { label: 'Shoppers World (Brampton)',           query: 'Shoppers World, Brampton ON' },
      { label: 'Square One (Mississauga)',            query: 'Square One, Mississauga ON' },
      { label: 'Churchill Meadows (Mississauga)',     query: 'Churchill Meadows, Mississauga ON' },
      { label: 'Mattamy National Cycling Centre',     query: 'Mattamy National Cycling Centre, Milton ON' }
    ];

    const GEO_CACHE = new Map();

    async function geocodePlace(query) {
      if (GEO_CACHE.has(query)) return GEO_CACHE.get(query);
      const url = `https://api.tomtom.com/search/2/search/${encodeURIComponent(query)}.json?key=${TOMTOM_API_KEY}&limit=1&countrySet=CA`;
      const res = await fetch(url);
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`Geocode ${res.status} ${t}`);
      }
      const data = await res.json();
      const pos = data?.results?.[0]?.position;
      if (!pos?.lat || !pos?.lon) throw new Error(`No geocode result for "${query}"`);
      const coord = { lat: pos.lat, lon: pos.lon };
      GEO_CACHE.set(query, coord);
      return coord;
    }

    async function getTomTomMinutes(origin, destCoord) {
      const path = `${origin.lat},${origin.lon}:${destCoord.lat},${destCoord.lon}`; // LAT,LON:LAT,LON
      const url  = `https://api.tomtom.com/routing/1/calculateRoute/${path}/json?routeType=fastest&traffic=true&travelMode=car&key=${TOMTOM_API_KEY}`;
      const res  = await fetch(url);
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`TomTom ${res.status} ${t}`);
      }
      const data = await res.json();
      const secs = data?.routes?.[0]?.summary?.travelTimeInSeconds;
      if (!secs) throw new Error('Invalid TomTom response shape');
      return Math.round(secs / 60);
    }

    function renderCommuteSkeleton() {
      const listHost = document.getElementById('travel-times');
      listHost.innerHTML = DESTINATIONS.map(d =>
        `<div class="commute-row" data-label="${d.label}" style="display:flex; justify-content:space-between; padding:8px 10px; border:1px solid var(--border-color); border-radius:10px; margin-bottom:8px; background:var(--panel-subtle);">
          <div style="font-weight:700;">${d.label}</div>
          <div class="commute-time" style="font-weight:800; color:#EF7F2B;">…</div>
        </div>`
      ).join('');
    }

    async function fetchAllCommutes() {
      const listHost = document.getElementById('travel-times');
      const tsEl = document.getElementById('travel-updated');
      if (!listHost.children.length) renderCommuteSkeleton();

      try {
        // Geocode all (once) then route all in parallel
        const coords = await Promise.all(DESTINATIONS.map(d => geocodePlace(d.query)));
        const results = await Promise.allSettled(coords.map(c => getTomTomMinutes(ORIGIN, c)));

        results.forEach((res, i) => {
          const row = listHost.querySelectorAll('.commute-row')[i];
          const timeEl = row?.querySelector('.commute-time');
          if (!timeEl) return;
          if (res.status === 'fulfilled') {
            timeEl.textContent = `${res.value} mins`;
            timeEl.style.color = '#EF7F2B';
          } else {
            timeEl.textContent = '—';
            timeEl.style.color = '#6B7280';
            console.error(`Commute "${DESTINATIONS[i].label}" failed:`, res.reason);
          }
        });

        const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        tsEl.textContent = `Updated ${ts}`;
      } catch (e) {
        console.error('Commutes error:', e);
        document.getElementById('travel-times').innerHTML =
          '<small style="color:var(--text-muted)">Travel times unavailable.</small>';
        document.getElementById('travel-updated').textContent = '';
      }
    }

    /* ========================== NEWS (FIXED) ========================== */

    // Minimal logo fallback (optional; map host -> logo URL if you want)
    const SOURCE_LOGOS = {};

    // Try direct fetch first; then AllOrigins (CORS-friendly proxy)
    async function fetchFeedDirect(url){
      const res = await fetch(url, { headers: { 'Accept': 'application/rss+xml, application/xml, text/xml, text/plain' }});
      if(!res.ok) throw new Error(`RSS ${res.status}`);
      return await res.text();
    }
    async function fetchFeedAllOrigins(url){
      const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res = await fetch(proxied);
      if(!res.ok) throw new Error(`AllOrigins ${res.status}`);
      return await res.text();
    }

    // Parse RSS/Atom XML into uniform item objects
    function parseRssXmlToItems(xmlText){
      const items = [];
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, "text/xml");
      // RSS
      const rssItems = Array.from(doc.querySelectorAll("item"));
      rssItems.forEach(n=>{
        const title = n.querySelector("title")?.textContent?.trim() || "";
        const link  = n.querySelector("link")?.textContent?.trim() || "";
        const desc  = n.querySelector("description")?.textContent || n.querySelector("content\\:encoded")?.textContent || "";
        const pub   = n.querySelector("pubDate")?.textContent || n.querySelector("dc\\:date")?.textContent || "";
        const sourceName = doc.querySelector("channel>title")?.textContent?.trim() || "";
        const content_html = desc;
        items.push({ title, link, description: desc, content_html, pubDate: pub, sourceName });
      });
      // Atom
      const atomEntries = Array.from(doc.querySelectorAll("entry"));
      atomEntries.forEach(n=>{
        const title = n.querySelector("title")?.textContent?.trim() || "";
        const linkEl= n.querySelector("link[rel='alternate']") || n.querySelector("link");
        const link  = linkEl?.getAttribute("href") || "";
        const desc  = n.querySelector("summary")?.textContent || n.querySelector("content")?.textContent || "";
        const pub   = n.querySelector("updated")?.textContent || n.querySelector("published")?.textContent || "";
        const sourceName = doc.querySelector("feed>title")?.textContent?.trim() || "";
        const content_html = desc;
        items.push({ title, link, description: desc, content_html, pubDate: pub, sourceName });
      });
      return items;
    }

    // Pull first reasonable image from description/content
    function extractImageUrl(itemLike){
      const html = (itemLike.description || itemLike.content_html || "");
      if(!html) return null;
      // img src=
      const m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
      if(m) return m[1];
      // figure or source
      const m2 = html.match(/<source[^>]+srcset=["']([^"']+)["']/i);
      if(m2) return m2[1];
      // plain URL
      const m3 = html.match(/https?:\/\/[^\s"']+\.(png|jpg|jpeg|gif|webp)/i);
      if(m3) return m3[0];
      return null;
    }

    // Simple scoring: recency + AI/marketing keyword bumps
    function scoreArticle(it){
      const now = Date.now();
      const t = Date.parse(it.pubDate || "") || now;
      const hoursOld = Math.max(1, (now - t) / 36e5);
      let score = 1000 / hoursOld; // fresh is good
      const text = `${it.title} ${it.description}`.toLowerCase();
      const boosts = [
        ["ai", 10], ["artificial intelligence", 10], ["openai", 12], ["google", 6],
        ["meta", 6], ["apple", 6], ["microsoft", 6], ["seo", 8], ["sem", 6],
        ["search", 5], ["content", 4], ["social", 4], ["ads", 3], ["marketing", 8],
        ["startup", 3], ["saas", 3], ["cloud", 3]
      ];
      for(const [kw, b] of boosts){ if(text.includes(kw)) score += b; }
      return score;
    }

    async function fetchNews(){
      try{
        const aggregated = [];

        for(const url of feedUrls){
          try{
            // try direct
            let items = [];
            try{
              const xml = await fetchFeedDirect(url);
              items = parseRssXmlToItems(xml);
            }catch{}

            // fallback: AllOrigins proxy
            if(items.length === 0){
              try{
                const xml2 = await fetchFeedAllOrigins(url);
                items = parseRssXmlToItems(xml2);
              }catch{}
            }

            if(items.length > 0){
              const host = (new URL(url)).hostname.replace('www.','');
              items.forEach(it => {
                if(!it.sourceName) it.sourceName = host;
                // normalize date
                if(!it.pubDate){ it.pubDate = new Date().toISOString(); }
              });
              aggregated.push(...items);
            } else {
              console.warn('Feed failed:', url);
            }
          }catch(fe){ console.warn('Feed error:', url, fe); }
        }

        if(aggregated.length===0){
          newsTicker.innerHTML = '<span class="ticker-item">No news fetched (blocked by CORS or network). Check console for details.</span>';
          const placeholder = {
            sourceName:'Ignite Digital', pubDate:new Date().toISOString(), title:'News temporarily unavailable', link:'#',
            description:'We’re having trouble fetching news feeds. Content will appear here once available.'
          };
          crossfadeReplace(featuredContainer, renderArticleNode(placeholder,'featured'));
          const gridWrapper = document.createElement('div');
          gridWrapper.className = 'grid-swap';
          for(let i=0;i<4;i++) gridWrapper.appendChild(renderArticleNode(placeholder,'grid'));
          crossfadeReplace(gridContainer, gridWrapper);
          return;
        }

        const scored = aggregated.map(item => ({item, score: scoreArticle(item)}))
                                 .sort((a,b)=> b.score - a.score || (Date.parse(b.item.pubDate||0) - Date.parse(a.item.pubDate||0)));

        // cap & diversify
        const TOP_N = 40;
        let top = scored.slice(0, TOP_N).map(s=>s.item);

        // ensure freshness ordering finally
        top.sort((a,b)=> Date.parse(b.pubDate||0) - Date.parse(a.pubDate||0));
        articlesPool = top.slice(0,30);

        newsTicker.innerHTML = `<span class="ticker-item">${articlesPool.map(i => `••• ${i.title} `).join('')}</span>`;

        if(articlesPool.length>0){
          currentArticleIndex = 0;
          rotateArticles();
        }
      }catch(e){
        console.error("News error:", e);
        newsTicker.innerHTML = '<span class="ticker-item">News unavailable.</span>';
      }
    }

    function rotateArticles(){
      if (articlesPool.length === 0) return;
      currentArticleIndex = currentArticleIndex % articlesPool.length;
      const featured = articlesPool[currentArticleIndex];
      const nextFeaturedNode = renderArticleNode(featured, 'featured');
      crossfadeReplace(featuredContainer, nextFeaturedNode);
      const gridWrapper = document.createElement('div');
      gridWrapper.className = 'grid-swap';
      for (let i = 1; i <= 4; i++){
        const idx = (currentArticleIndex + i) % articlesPool.length;
        gridWrapper.appendChild(renderArticleNode(articlesPool[idx], 'grid'));
      }
      crossfadeReplace(gridContainer, gridWrapper);
      currentArticleIndex++;
    }

    function renderArticle(item, type) {
      const summaryLen = type === 'featured' ? 190 : 90;

      const srcName = (item.sourceName || "").trim();
      const html = item.description || '';
      const imageUrl = extractImageUrl(item);
      let primarySrc;
      if (imageUrl) {
          primarySrc = imageUrl;
      } else {
          const seed = encodeURIComponent(item.title || item.link || Math.random().toString(36).slice(2));
          const width = type === 'featured' ? 720 : 400;
          const height = type === 'featured' ? 405 : 225;
          primarySrc = `https://picsum.photos/seed/${seed}/${width}/${height}`;
      }

      const finalFallback = `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJz48cmVjdCB3aWR0aD0nODAwJyBoZWlnaHQ9JzYwMCcgZmlsbD0nI0YwRjJGNSAnPjwvcmVjdD48dGV4dCB4PSc1MCUnIHk9JzUwJScgZm9udC1mYW1pbHk9J3NhbnMtc2VyaWYnIGZvbnQtc2l6ZT0nMjQnIGZpbGw9JyNBN0E4QUMnIHRleHQtYW5jaGyPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnPkltYWdlIFVuYXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==`;
      const logoFallback = SOURCE_LOGOS[srcName] || finalFallback;
      const img = `<img src="${primarySrc}" alt="" class="article-image" loading="lazy"
          referrerpolicy="no-referrer"
          onerror="this.onerror=null; this.src='${logoFallback}'; this.onerror=() => { this.src='${finalFallback}'; };">`;

      const title = item.title || 'Untitled';
      const link  = item.link || '#';
      const pub   = item.pubDate || new Date().toISOString();

      return `<div class="card ${type}-card">
        ${img}
        <div class="article-content">
            <div class="article-header">
                <span class="source-label">${srcName || 'Source'}</span>
                <span class="time-ago">${formatTimeAgo(pub)}</span>
            </div>
            <h2 class="article-title"><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></h2>
            <p class="article-summary">${truncateText(html, summaryLen)}</p>
        </div>
      </div>`;
    }

    /* ========================== QUOTE & WORD ========================== */
    async function fetchQuote(){
      try{
        let res = await fetch('https://zenquotes.io/api/random');
        if (!res.ok) throw new Error(`ZenQuotes ${res.status}`);
        let data = await res.json();
        const q = Array.isArray(data) ? data[0] : null;
        if(!q || !q.q || !q.a) throw new Error('ZenQuotes shape');
        quoteContent.innerHTML =
          `<div class="quote-content">“${q.q}”</div><div class="quote-author">— ${q.a}</div>`;
      } catch (e1) {
        try{
          const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent('https://zenquotes.io/api/random')}`;
          const res2 = await fetch(proxied);
          if (!res2.ok) throw new Error(`Proxy ${res2.status}`);
          const data2 = await res2.json();
          const q2 = Array.isArray(data2) ? data2[0] : null;
          if(q2 && q2.q && q2.a){
            quoteContent.innerHTML =
              `<div class="quote-content">“${q2.q}”</div><div class="quote-author">— ${q2.a}</div>`;
            return;
          }
          throw new Error('Proxy shape');
        } catch (e2) {
          try{
            const res3 = await fetch('https://api.quotable.io/random');
            if (!res3.ok) throw new Error(`Quotable ${res3.status}`);
            const d3 = await res3.json();
            if(d3 && d3.content && d3.author){
              quoteContent.innerHTML =
                `<div class="quote-content">“${d3.content}”</div><div class="quote-author">— ${d3.author}</div>`;
              return;
            }
          } catch {}
          quoteContent.innerHTML = '<small style="color:var(--text-muted)">Quote unavailable.</small>';
        }
      }
    }

    async function fetchWordOfTheDay(){
      try{
        const startOfYear = new Date(new Date().getFullYear(),0,0);
        const diff = new Date() - startOfYear;
        const dayOfYear = Math.floor(diff / (1000*60*60*24));
        const word = dailyWords[dayOfYear % dailyWords.length];

        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
        const data = await res.json();
        const entry = Array.isArray(data) && data[0] ? data[0] : null;
        if(!entry) throw new Error('No dictionary entry');
        const def = entry.meanings?.[0]?.definitions?.[0]?.definition || '';
        const phon = entry.phonetic || '';
        wordContent.innerHTML = `<div class="word">${word}</div><div class="phonetic">${phon}</div><div class="definition">${def}</div>`;
      }catch(e){
        console.warn("Word error:", e);
        wordContent.innerHTML = '<small style="color:var(--text-muted)">Word unavailable.</small>';
      }
    }

    /* ========================== INIT & TIMERS ========================== */
    updateTimezones();
    fetchWeather();
    fetchAllCommutes();          // First load
    fetchNews();
    fetchQuote();
    fetchWordOfTheDay();

    setInterval(updateTimezones, 1000);          // timezones refresh every second
    setInterval(fetchWeather, 60 * 60 * 1000);   // hourly
    setInterval(fetchAllCommutes, 900000);       // every 15 min
    setInterval(fetchNews, 30 * 60 * 1000);      // 30 min refresh
    setInterval(rotateArticles, 30 * 1000);      // rotate display
    setInterval(fetchQuote, 10 * 60 * 1000);
    setInterval(fetchWordOfTheDay, 60 * 60 * 1000);
  </script>
</body>
</html>

